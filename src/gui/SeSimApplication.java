/*
 * Copyright (c) 2017, 7u83 <7u83@mail.ru>
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are met:
 *
 * * Redistributions of source code must retain the above copyright notice, this
 *   list of conditions and the following disclaimer.
 * * Redistributions in binary form must reproduce the above copyright notice,
 *   this list of conditions and the following disclaimer in the documentation
 *   and/or other materials provided with the distribution.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
 * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE
 * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
 * POSSIBILITY OF SUCH DAMAGE.
 */
package gui;

import java.awt.Dialog;
import java.awt.Frame;
import java.awt.GraphicsDevice;
import java.awt.GraphicsEnvironment;
import java.awt.Toolkit;
import java.awt.event.WindowAdapter;
import java.awt.event.WindowEvent;
import java.io.File;
import java.io.IOException;
import java.io.InputStream;
import java.util.Scanner;
import java.util.logging.ConsoleHandler;
import java.util.logging.Level;
import java.util.logging.Logger;
import java.util.logging.SimpleFormatter;
import java.util.prefs.Preferences;
import javax.swing.JDialog;
import javax.swing.JFileChooser;
import javax.swing.JFrame;
import javax.swing.JOptionPane;
import javax.swing.JPopupMenu;
import static javax.swing.ScrollPaneConstants.VERTICAL_SCROLLBAR_NEVER;
import javax.swing.filechooser.FileFilter;
import javax.swing.filechooser.FileNameExtensionFilter;
import org.json.JSONObject;
import sesim.Order;

/**
 *
 * @author 7u83 <7u83@mail.ru>
 */
public class SeSimApplication extends javax.swing.JFrame {

    /**
     * Creates new form NewMDIApplication
     */
    public SeSimApplication() {

        initComponents();

        GraphicsEnvironment ge = GraphicsEnvironment.getLocalGraphicsEnvironment();
        GraphicsDevice[] screens = ge.getScreenDevices();

        //Window w = screens[1].getFullScreenWindow();
//            JFrame dummy = new JFrame(screens[1].getDefaultConfiguration());
        //          setLocationRelativeTo(dummy);
        //          dummy.dispose();
        for (GraphicsDevice gd : screens) {
            //Window w = gd.getFullScreenWindow();

        }

        initSim();
        setTitle("");
        boolean init = Globals.prefs_new.getBoolean("initilized", false);
        if (!init) {
            resetToDefaults();
            Globals.prefs_new.putBoolean("initilized", true);
        }
//        this.chartSrollPane.setVerticalScrollBarPolicy(VERTICAL_SCROLLBAR_NEVER);
        //this.setLocationRelativeTo(null);
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        jScrollPane2 = new javax.swing.JScrollPane();
        jTextArea1 = new javax.swing.JTextArea();
        jSplitPane1 = new javax.swing.JSplitPane();
        jSplitPane2 = new javax.swing.JSplitPane();
        orderBookNew1 = new gui.orderbook.RawOrderBook();
        jPanel2 = new javax.swing.JPanel();
        accelSpinner = new javax.swing.JSpinner();
        clock = new gui.Clock();
        jLabel1 = new javax.swing.JLabel();
        jToolBar1 = new javax.swing.JToolBar();
        runButton = new javax.swing.JButton();
        pauseButton = new javax.swing.JButton();
        stopButton = new javax.swing.JButton();
        jSplitPane3 = new javax.swing.JSplitPane();
        jSplitPane4 = new javax.swing.JSplitPane();
        chartPanel = new chart.ChartPanel();
        orderBooksHorizontal = new gui.orderbook.OrderBooksHorizontal();
        quoteVertical1 = new gui.orderbook.QuoteVertical();
        jSplitPane5 = new javax.swing.JSplitPane();
        statistics1 = new gui.Statistics();
        clock1 = new gui.Clock();
        traderListPanel1 = new gui.TraderListPanel();
        menuBar = new javax.swing.JMenuBar();
        fileMenu = new javax.swing.JMenu();
        openMenuItem = new javax.swing.JMenuItem();
        saveMenuItem = new javax.swing.JMenuItem();
        saveAsMenuItem = new javax.swing.JMenuItem();
        closeMenuItem = new javax.swing.JMenuItem();
        jSeparator5 = new javax.swing.JPopupMenu.Separator();
        resetToDefaultsMenuItem = new javax.swing.JMenuItem();
        clearMenuItem = new javax.swing.JMenuItem();
        jSeparator4 = new javax.swing.JPopupMenu.Separator();
        exitMenuItem = new javax.swing.JMenuItem();
        editMenu = new javax.swing.JMenu();
        editExchangeMenuItem = new javax.swing.JMenuItem();
        jSeparator1 = new javax.swing.JPopupMenu.Separator();
        pasteMenuItem = new javax.swing.JMenuItem();
        deleteMenuItem = new javax.swing.JMenuItem();
        jSeparator2 = new javax.swing.JPopupMenu.Separator();
        editPreferences = new javax.swing.JMenuItem();
        simMenu = new javax.swing.JMenu();
        simMenuStart = new javax.swing.JMenuItem();
        simMenuPause = new javax.swing.JMenuItem();
        simMenuStop = new javax.swing.JMenuItem();
        viewMenu = new javax.swing.JMenu();
        viewTraderListCheckBox = new javax.swing.JCheckBoxMenuItem();
        viewRawOrderBook = new javax.swing.JCheckBoxMenuItem();
        viewUnlimitedOrdes = new javax.swing.JCheckBoxMenuItem();
        viewStopOrders = new javax.swing.JCheckBoxMenuItem();
        helpMenu = new javax.swing.JMenu();
        aboutMenuItem = new javax.swing.JMenuItem();

        jTextArea1.setColumns(20);
        jTextArea1.setRows(5);
        jTextArea1.setText("Hakke");
        jScrollPane2.setViewportView(jTextArea1);

        jSplitPane1.setOrientation(javax.swing.JSplitPane.VERTICAL_SPLIT);

        jSplitPane2.setLeftComponent(orderBookNew1);

        jSplitPane1.setTopComponent(jSplitPane2);

        setDefaultCloseOperation(javax.swing.WindowConstants.EXIT_ON_CLOSE);
        setTitle("SeSim - Stock Exchange Simmulator");
        setMinimumSize(new java.awt.Dimension(640, 480));

        accelSpinner.setModel(new javax.swing.SpinnerNumberModel(1.0d, 0.0d, null, 1.0d));
        accelSpinner.addChangeListener(new javax.swing.event.ChangeListener() {
            public void stateChanged(javax.swing.event.ChangeEvent evt) {
                accelSpinnerStateChanged(evt);
            }
        });
        accelSpinner.addPropertyChangeListener(new java.beans.PropertyChangeListener() {
            public void propertyChange(java.beans.PropertyChangeEvent evt) {
                accelSpinnerPropertyChange(evt);
            }
        });

        jLabel1.setText("Acceleration:");

        jToolBar1.setRollover(true);

        runButton.setFont(runButton.getFont());
        runButton.setIcon(new javax.swing.ImageIcon(getClass().getResource("/resources/icons/run.gif"))); // NOI18N
        runButton.setText("Run sim!");
        runButton.setToolTipText("Run the simmulation");
        runButton.setHorizontalTextPosition(javax.swing.SwingConstants.CENTER);
        runButton.setVerticalTextPosition(javax.swing.SwingConstants.BOTTOM);
        runButton.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                runButtonActionPerformed(evt);
            }
        });
        jToolBar1.add(runButton);

        pauseButton.setIcon(new javax.swing.ImageIcon(getClass().getResource("/resources/icons/pause.gif"))); // NOI18N
        pauseButton.setText("Pause");
        pauseButton.setHorizontalTextPosition(javax.swing.SwingConstants.CENTER);
        pauseButton.setVerticalTextPosition(javax.swing.SwingConstants.BOTTOM);
        pauseButton.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                pauseButtonActionPerformed(evt);
            }
        });
        jToolBar1.add(pauseButton);

        stopButton.setIcon(new javax.swing.ImageIcon(getClass().getResource("/resources/icons/stop.gif"))); // NOI18N
        stopButton.setText("Stop");
        stopButton.setHorizontalTextPosition(javax.swing.SwingConstants.CENTER);
        stopButton.setVerticalTextPosition(javax.swing.SwingConstants.BOTTOM);
        stopButton.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                stopButtonActionPerformed(evt);
            }
        });
        jToolBar1.add(stopButton);

        javax.swing.GroupLayout jPanel2Layout = new javax.swing.GroupLayout(jPanel2);
        jPanel2.setLayout(jPanel2Layout);
        jPanel2Layout.setHorizontalGroup(
            jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel2Layout.createSequentialGroup()
                .addComponent(jToolBar1, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, 94, Short.MAX_VALUE)
                .addComponent(jLabel1)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                .addComponent(accelSpinner, javax.swing.GroupLayout.PREFERRED_SIZE, 100, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(32, 32, 32)
                .addComponent(clock, javax.swing.GroupLayout.PREFERRED_SIZE, 139, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addContainerGap())
        );
        jPanel2Layout.setVerticalGroup(
            jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel2Layout.createSequentialGroup()
                .addGroup(jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(jPanel2Layout.createSequentialGroup()
                        .addGap(3, 3, 3)
                        .addComponent(clock, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                    .addGroup(jPanel2Layout.createSequentialGroup()
                        .addGap(11, 11, 11)
                        .addGroup(jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                            .addComponent(jLabel1)
                            .addComponent(accelSpinner, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)))
                    .addGroup(jPanel2Layout.createSequentialGroup()
                        .addContainerGap()
                        .addComponent(jToolBar1, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)))
                .addGap(0, 12, Short.MAX_VALUE))
        );

        getContentPane().add(jPanel2, java.awt.BorderLayout.PAGE_START);

        jSplitPane4.setDividerLocation(300);
        jSplitPane4.setOrientation(javax.swing.JSplitPane.VERTICAL_SPLIT);
        jSplitPane4.setLeftComponent(chartPanel);
        jSplitPane4.setRightComponent(orderBooksHorizontal);

        jSplitPane3.setRightComponent(jSplitPane4);
        jSplitPane3.setLeftComponent(quoteVertical1);

        jSplitPane5.setOrientation(javax.swing.JSplitPane.VERTICAL_SPLIT);
        jSplitPane5.setTopComponent(statistics1);
        jSplitPane5.setRightComponent(clock1);
        jSplitPane5.setBottomComponent(traderListPanel1);

        jSplitPane3.setLeftComponent(jSplitPane5);

        getContentPane().add(jSplitPane3, java.awt.BorderLayout.CENTER);

        fileMenu.setMnemonic('f');
        fileMenu.setText("File");

        openMenuItem.setAccelerator(javax.swing.KeyStroke.getKeyStroke(java.awt.event.KeyEvent.VK_O, java.awt.event.InputEvent.CTRL_DOWN_MASK));
        openMenuItem.setMnemonic('o');
        openMenuItem.setText("Open");
        openMenuItem.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                openMenuItemActionPerformed(evt);
            }
        });
        fileMenu.add(openMenuItem);

        saveMenuItem.setAccelerator(javax.swing.KeyStroke.getKeyStroke(java.awt.event.KeyEvent.VK_S, java.awt.event.InputEvent.CTRL_DOWN_MASK));
        saveMenuItem.setMnemonic('s');
        saveMenuItem.setText("Save");
        saveMenuItem.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                saveMenuItemActionPerformed(evt);
            }
        });
        fileMenu.add(saveMenuItem);

        saveAsMenuItem.setMnemonic('a');
        saveAsMenuItem.setText("Save As ...");
        saveAsMenuItem.setDisplayedMnemonicIndex(5);
        saveAsMenuItem.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                saveAsMenuItemActionPerformed(evt);
            }
        });
        fileMenu.add(saveAsMenuItem);

        closeMenuItem.setMnemonic('c');
        closeMenuItem.setText("Close");
        closeMenuItem.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                closeMenuItemActionPerformed(evt);
            }
        });
        fileMenu.add(closeMenuItem);
        fileMenu.add(jSeparator5);

        resetToDefaultsMenuItem.setMnemonic('r');
        resetToDefaultsMenuItem.setText("Reset to defaults");
        resetToDefaultsMenuItem.setToolTipText("");
        resetToDefaultsMenuItem.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                resetToDefaultsMenuItemActionPerformed(evt);
            }
        });
        fileMenu.add(resetToDefaultsMenuItem);

        clearMenuItem.setMnemonic('c');
        clearMenuItem.setText("Clear All");
        clearMenuItem.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                clearMenuItemActionPerformed(evt);
            }
        });
        fileMenu.add(clearMenuItem);
        fileMenu.add(jSeparator4);

        exitMenuItem.setAccelerator(javax.swing.KeyStroke.getKeyStroke(java.awt.event.KeyEvent.VK_Q, java.awt.event.InputEvent.CTRL_DOWN_MASK));
        exitMenuItem.setMnemonic('x');
        exitMenuItem.setText("Exit");
        exitMenuItem.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                exitMenuItemActionPerformed(evt);
            }
        });
        fileMenu.add(exitMenuItem);

        menuBar.add(fileMenu);

        editMenu.setMnemonic('e');
        editMenu.setText("Edit");

        editExchangeMenuItem.setMnemonic('y');
        editExchangeMenuItem.setText("Exchange ...");
        editExchangeMenuItem.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                editExchangeMenuItemActionPerformed(evt);
            }
        });
        editMenu.add(editExchangeMenuItem);
        editMenu.add(jSeparator1);

        pasteMenuItem.setMnemonic('s');
        pasteMenuItem.setText("Strategies ...");
        pasteMenuItem.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                pasteMenuItemActionPerformed(evt);
            }
        });
        editMenu.add(pasteMenuItem);

        deleteMenuItem.setMnemonic('d');
        deleteMenuItem.setText("Traders ...");
        deleteMenuItem.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                deleteMenuItemActionPerformed(evt);
            }
        });
        editMenu.add(deleteMenuItem);
        editMenu.add(jSeparator2);

        editPreferences.setMnemonic('p');
        editPreferences.setText("Preferences ...");
        editPreferences.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                editPreferencesActionPerformed(evt);
            }
        });
        editMenu.add(editPreferences);

        menuBar.add(editMenu);

        simMenu.setMnemonic('s');
        simMenu.setText("Sim");

        simMenuStart.setMnemonic('s');
        simMenuStart.setText("Start");
        simMenuStart.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                simMenuStartActionPerformed(evt);
            }
        });
        simMenu.add(simMenuStart);

        simMenuPause.setMnemonic('p');
        simMenuPause.setText("Pause");
        simMenuPause.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                simMenuPauseActionPerformed(evt);
            }
        });
        simMenu.add(simMenuPause);

        simMenuStop.setMnemonic('t');
        simMenuStop.setText("Stop");
        simMenuStop.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                simMenuStopActionPerformed(evt);
            }
        });
        simMenu.add(simMenuStop);

        menuBar.add(simMenu);

        viewMenu.setMnemonic('v');
        viewMenu.setText("View");

        viewTraderListCheckBox.setMnemonic('t');
        viewTraderListCheckBox.setText("Traders");
        viewTraderListCheckBox.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                viewTraderListCheckBoxActionPerformed(evt);
            }
        });
        viewMenu.add(viewTraderListCheckBox);

        viewRawOrderBook.setAccelerator(javax.swing.KeyStroke.getKeyStroke(java.awt.event.KeyEvent.VK_O, 0));
        viewRawOrderBook.setMnemonic('R');
        viewRawOrderBook.setText("Level 3 Orde Book");
        viewRawOrderBook.setToolTipText("");
        viewRawOrderBook.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                viewRawOrderBookActionPerformed(evt);
            }
        });
        viewMenu.add(viewRawOrderBook);

        viewUnlimitedOrdes.setAccelerator(javax.swing.KeyStroke.getKeyStroke(java.awt.event.KeyEvent.VK_M, 0));
        viewUnlimitedOrdes.setText("Market Orders View");
        viewUnlimitedOrdes.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                viewUnlimitedOrdesActionPerformed(evt);
            }
        });
        viewMenu.add(viewUnlimitedOrdes);

        viewStopOrders.setAccelerator(javax.swing.KeyStroke.getKeyStroke(java.awt.event.KeyEvent.VK_S, 0));
        viewStopOrders.setText("Stop Orders View");
        viewStopOrders.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                viewStopOrdersActionPerformed(evt);
            }
        });
        viewMenu.add(viewStopOrders);

        menuBar.add(viewMenu);

        helpMenu.setMnemonic('h');
        helpMenu.setText("Help");

        aboutMenuItem.setMnemonic('a');
        aboutMenuItem.setText("About");
        aboutMenuItem.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                aboutMenuItemActionPerformed(evt);
            }
        });
        helpMenu.add(aboutMenuItem);

        menuBar.add(helpMenu);

        setJMenuBar(menuBar);

        pack();
    }// </editor-fold>//GEN-END:initComponents

    private void exitMenuItemActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_exitMenuItemActionPerformed
        System.exit(0);
    }//GEN-LAST:event_exitMenuItemActionPerformed

    private void aboutMenuItemActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_aboutMenuItemActionPerformed
        Dialog d = new gui.AboutDialog(this, rootPaneCheckingEnabled);
        d.setVisible(rootPaneCheckingEnabled);

    }//GEN-LAST:event_aboutMenuItemActionPerformed

    void pauseSim() {

        if (Globals.sim.se.timer.getPause()) {
            this.runButton.setEnabled(false);
            this.pauseButton.setEnabled(true);

        } else {
            this.runButton.setEnabled(true);
            this.pauseButton.setEnabled(false);

        }
        Globals.sim.se.timer.pause();
    }

    void startSim() {

        if (Globals.sim.se.timer.getPause()) {

            pauseSim();
            return;
        }

        this.runButton.setEnabled(false);
        this.stopButton.setEnabled(true);

        //Globals.sim.se.terminate();
        Globals.sim.reset();
        Globals.sim.startTraders(Globals.getConfig());
        Globals.sim.se.timer.setPause(false);
        Globals.sim.se.timer.start();
        Globals.sim.se.timer.setAcceleration((Double) this.accelSpinner.getValue());

        chartPanel.reset();
        if (this.rawOrderBookDialog != null) {
            this.rawOrderBookDialog.start(Globals.sim.se, Order.BUYLIMIT, Order.SELLLIMIT);
        }

        this.orderBooksHorizontal.start();

        this.stopButton.setEnabled(true);
        this.pauseButton.setEnabled(true);

        this.orderBooksHorizontal.invalidate();
        this.orderBooksHorizontal.repaint();
        this.clock.invalidate();
        this.clock.repaint();

        this.chartPanel.reset();

        this.clock.invalidate();
        this.clock.repaint();

    }

    void stopSim() {
        Globals.sim.se.timer.terminate();
        this.stopButton.setEnabled(false);
        this.pauseButton.setEnabled(false);
        this.runButton.setEnabled(true);
    }

    void resetSim() {
        //      Globals.sim.se.terminate();
        Globals.sim.reset();
        chartPanel.reset();
        if (this.rawOrderBookDialog != null) {
            this.rawOrderBookDialog.start(Globals.sim.se, Order.BUYLIMIT, Order.SELLLIMIT);
        }

        this.orderBooksHorizontal.start();

//        chart.initChart();
//        chart.invalidate();
//        chart.repaint();
    }

    private void initSim() {
        this.runButton.setEnabled(true);
        this.stopButton.setEnabled(false);
        this.pauseButton.setEnabled(false);
    }


    private void editPreferencesActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_editPreferencesActionPerformed
        //      Globals.LOGGER.info("Edit prefs...");

        Dialog d = new gui.EditPreferencesDialog(this, rootPaneCheckingEnabled);
        d.setVisible(rootPaneCheckingEnabled);
    }//GEN-LAST:event_editPreferencesActionPerformed


    private void deleteMenuItemActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_deleteMenuItemActionPerformed
        EditAutoTraderListDialog ed = new EditAutoTraderListDialog(this, true);
        ed.setVisible(rootPaneCheckingEnabled);


    }//GEN-LAST:event_deleteMenuItemActionPerformed

    private void pasteMenuItemActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_pasteMenuItemActionPerformed
        EditStrategies s = new EditStrategies(this, false);

        s.setVisible(rootPaneCheckingEnabled);


    }//GEN-LAST:event_pasteMenuItemActionPerformed

    //   private final LoggerDialog log_d = new LoggerDialog(this, false);

    private void openMenuItemActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_openMenuItemActionPerformed
        JFileChooser fc = getFileChooser();

        while (true) {
            if (fc.showOpenDialog(this) != JFileChooser.APPROVE_OPTION) {
                return;
            }

            try {
                File f = fc.getSelectedFile();
                Globals.loadFile(f);
                String workdir = fc.getCurrentDirectory().getAbsolutePath();
                Globals.prefs_new.put(Globals.PrefKeys.WORKDIR, workdir);
                Globals.prefs_new.put(Globals.PrefKeys.CURRENTFILE, f.getAbsolutePath());
                setTitle(f.getName());
                return;

            } catch (Exception ex) {
                JOptionPane.showMessageDialog(this, "Can't load file: " + ex.getMessage(), "Error", JOptionPane.ERROR_MESSAGE);
            }

        }
    }//GEN-LAST:event_openMenuItemActionPerformed

    // initialize a JFileChoser with  working directory and extension
    private JFileChooser getFileChooser() {
        JFileChooser fc = new JFileChooser();

        String workdir = Globals.prefs_new.get(Globals.PrefKeys.WORKDIR, "");
        fc.setCurrentDirectory(new File(workdir));

        FileNameExtensionFilter sesim_filter = new FileNameExtensionFilter("SeSim Files", Globals.SESIM_FILEEXTENSION);
        fc.setFileFilter(sesim_filter);
        return fc;
    }

    @Override
    public final void setTitle(String filename) {
        String name;
        name = Globals.SESIM_APPTITLE;
        if (!"".equals(filename)) {
            name += " (" + filename + ")";
        }
        super.setTitle(name);
    }

    private void saveFile(boolean saveAs) {
        JFileChooser fc = getFileChooser();
        FileFilter sesim_filter = fc.getFileFilter();

        while (true) {
            String current_file = Globals.prefs_new.get(Globals.PrefKeys.CURRENTFILE, "");
            File fobj;

            if (saveAs || "".equals(current_file)) {

                if (!"".equals(current_file)) {
                    fobj = new File(current_file);
                    fc.setSelectedFile(fobj);
                    fc.setCurrentDirectory(fobj);
                }

                saveAs = true;
                if (fc.showSaveDialog(this) != JFileChooser.APPROVE_OPTION) {
                    return;
                }
            } else {
                fobj = new File(current_file);
                fc.setSelectedFile(fobj);
                fc.setCurrentDirectory(fobj);
            }

            File f = fc.getSelectedFile();
            String workdir = fc.getCurrentDirectory().getAbsolutePath();
            Globals.prefs_new.put(Globals.PrefKeys.WORKDIR, workdir);
            String fn = f.getAbsolutePath();

            if (f.exists() && saveAs) {
                String s = String.format("File %s already exists. Do you want to overwrite?", fn);
                int dialogResult = JOptionPane.showConfirmDialog(this, s, "Warning", JOptionPane.YES_NO_OPTION);
                if (dialogResult != JOptionPane.YES_OPTION) {
                    continue;
                }

            }

            FileFilter selected_filter = fc.getFileFilter();
            if (selected_filter == sesim_filter) {
                System.out.printf("Filter", selected_filter.toString());
                if (!fn.toLowerCase().endsWith("." + Globals.SESIM_FILEEXTENSION)) {
                    f = new File(fn + "." + Globals.SESIM_FILEEXTENSION);
                }
            }

            try {
                Globals.saveFile(f);
                Globals.prefs_new.put(Globals.PrefKeys.CURRENTFILE, fn);
                setTitle(f.getName());
                return;

            } catch (Exception ex) {

                JOptionPane.showMessageDialog(this, "Can't save file: " + ex.getMessage(), "Error", JOptionPane.ERROR_MESSAGE);

            }

        }

    }


    private void saveAsMenuItemActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_saveAsMenuItemActionPerformed

        this.saveFile(true);
    }//GEN-LAST:event_saveAsMenuItemActionPerformed

    private void editExchangeMenuItemActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_editExchangeMenuItemActionPerformed
        EditExchangeDialog ed = new EditExchangeDialog((Frame) this.getParent(), true);
        int rc = ed.showdialog();
        //  System.out.printf("EDRET: %d\n",rc);

    }//GEN-LAST:event_editExchangeMenuItemActionPerformed

    private void resetToDefaults() {
        InputStream is = getClass().getResourceAsStream("/resources/files/defaultcfg.json");
        String df = new Scanner(is, "UTF-8").useDelimiter("\\A").next();

        try {
            Globals.loadString(df);
        } catch (IOException ex) {
            JOptionPane.showMessageDialog(this, "Can't load file: " + ex.getMessage(), "Error", JOptionPane.ERROR_MESSAGE);

        }

    }

    private void resetToDefaultsMenuItemActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_resetToDefaultsMenuItemActionPerformed

        int dialogResult = JOptionPane.showConfirmDialog(this, "Are you sure?", "Warning", JOptionPane.YES_NO_OPTION);
        if (dialogResult != JOptionPane.YES_OPTION) {
            return;
        }

        this.resetToDefaults();

    }//GEN-LAST:event_resetToDefaultsMenuItemActionPerformed

    private void simMenuStartActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_simMenuStartActionPerformed
        startSim();
    }//GEN-LAST:event_simMenuStartActionPerformed

    private void simMenuPauseActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_simMenuPauseActionPerformed
        pauseSim();
    }//GEN-LAST:event_simMenuPauseActionPerformed

    private void simMenuStopActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_simMenuStopActionPerformed
        stopSim();
    }//GEN-LAST:event_simMenuStopActionPerformed

    private void accelSpinnerStateChanged(javax.swing.event.ChangeEvent evt) {//GEN-FIRST:event_accelSpinnerStateChanged
        Double val = (Double) this.accelSpinner.getValue();
        Globals.sim.se.timer.setAcceleration(val);
    }//GEN-LAST:event_accelSpinnerStateChanged

    private void pauseButtonActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_pauseButtonActionPerformed
        //Globals.sim.se.timer.pause();
        pauseSim();
    }//GEN-LAST:event_pauseButtonActionPerformed

    private void runButtonActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_runButtonActionPerformed
        startSim();
    }//GEN-LAST:event_runButtonActionPerformed

    private void stopButtonActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_stopButtonActionPerformed
        stopSim();
    }//GEN-LAST:event_stopButtonActionPerformed

    RawOrderBookDialog rawOrderBookDialog = null;

//new gui.orderbook.OrderBookDialog(this, false);

    private void viewRawOrderBookActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_viewRawOrderBookActionPerformed

        javax.swing.SwingUtilities.invokeLater(() -> {
            //  TraderListDialog traderListDialog = null;

            if (this.viewRawOrderBook.getState()) {
                if (rawOrderBookDialog == null) {

                    rawOrderBookDialog = new RawOrderBookDialog(this, false);

                    rawOrderBookDialog.start(Globals.sim.se, Order.BUYLIMIT, Order.SELLLIMIT);
                    rawOrderBookDialog.setTitle("Level 3 Order Book");

                    rawOrderBookDialog.addWindowListener(new WindowAdapter() {
                        @Override
                        public void windowClosing(WindowEvent e) {
                            super.windowClosing(e);

                            System.out.printf("Closingn");
                            rawOrderBookDialog.dispose();
                            rawOrderBookDialog.stop();
                            rawOrderBookDialog = null;
                            viewRawOrderBook.setState(false);
                        }
                    });

                }

                rawOrderBookDialog.setVisible(true);
            } else if (rawOrderBookDialog != null) {
                System.out.printf("Set visible = false\n");
                rawOrderBookDialog.setVisible(false);

            }
        });

        //  rawOrderBookDialog.setVisible(rootPaneCheckingEnabled);
    }//GEN-LAST:event_viewRawOrderBookActionPerformed


    private void viewTraderListCheckBoxActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_viewTraderListCheckBoxActionPerformed

        javax.swing.SwingUtilities.invokeLater(() -> {
            TraderListDialog traderListDialog = null;

            if (this.viewTraderListCheckBox.getState()) {
                if (traderListDialog == null) {
                    traderListDialog = new TraderListDialog(this, false);
                    traderListDialog.addWindowListener(new WindowAdapter() {
                        @Override
                        public void windowClosing(WindowEvent e) {
                            super.windowClosing(e);
                            viewTraderListCheckBox.setState(false);
                            System.out.printf("Set menu false\n");
                        }
                    });

                }

                traderListDialog.setVisible(true);
            } else if (traderListDialog != null) {
                System.out.printf("Set visible = false\n");
                traderListDialog.setVisible(false);
            }
        });

    }//GEN-LAST:event_viewTraderListCheckBoxActionPerformed

    private void accelSpinnerPropertyChange(java.beans.PropertyChangeEvent evt) {//GEN-FIRST:event_accelSpinnerPropertyChange
//        System.out.printf("Accel Spinner PRop Change\n");
    }//GEN-LAST:event_accelSpinnerPropertyChange

    private void saveMenuItemActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_saveMenuItemActionPerformed
        saveFile(false);

    }//GEN-LAST:event_saveMenuItemActionPerformed

    private void closeMenuItemActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_closeMenuItemActionPerformed
        Globals.prefs_new.put(Globals.PrefKeys.CURRENTFILE, "");
        setTitle("");
    }//GEN-LAST:event_closeMenuItemActionPerformed

    private void clearMenuItemActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_clearMenuItemActionPerformed

        int dialogResult = JOptionPane.showConfirmDialog(this, "Are you sure?", "Warning", JOptionPane.YES_NO_OPTION);
        if (dialogResult != JOptionPane.YES_OPTION) {
            return;
        }
        Globals.clearAll();
    }//GEN-LAST:event_clearMenuItemActionPerformed

    RawOrderBookDialog stopOrderBookDialog = null;

    RawOrderBookDialog unlimitedOrdersDialog = null;

    private void viewUnlimitedOrdesActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_viewUnlimitedOrdesActionPerformed

        javax.swing.SwingUtilities.invokeLater(() -> {
            //  TraderListDialog traderListDialog = null;

            if (this.viewUnlimitedOrdes.getState()) {
                if (unlimitedOrdersDialog == null) {

                    unlimitedOrdersDialog = new RawOrderBookDialog(this, false);

                    unlimitedOrdersDialog.start(Globals.sim.se, Order.BUY, Order.SELL);
                    unlimitedOrdersDialog.setTitle("Unlimited Orders");

                    unlimitedOrdersDialog.addWindowListener(new WindowAdapter() {
                        @Override
                        public void windowClosing(WindowEvent e) {
                            super.windowClosing(e);

                            System.out.printf("Closingn");
                            unlimitedOrdersDialog.dispose();
                            unlimitedOrdersDialog.stop();
                            unlimitedOrdersDialog = null;
                            viewUnlimitedOrdes.setState(false);
                        }
                    });

                }

                unlimitedOrdersDialog.setVisible(true);
            } else if (unlimitedOrdersDialog != null) {
                System.out.printf("Set visible = false\n");
                unlimitedOrdersDialog.setVisible(false);

            }
        });


    }//GEN-LAST:event_viewUnlimitedOrdesActionPerformed

    private void viewStopOrdersActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_viewStopOrdersActionPerformed

        javax.swing.SwingUtilities.invokeLater(() -> {
            //  TraderListDialog traderListDialog = null;

            if (this.viewStopOrders.getState()) {
                if (stopOrderBookDialog == null) {

                    stopOrderBookDialog = new RawOrderBookDialog(this, false);

                    stopOrderBookDialog.start(Globals.sim.se, Order.BUYSTOP , Order.SELLSTOP);
                    stopOrderBookDialog.setTitle("Stop Orders");
                    stopOrderBookDialog.setTitles("Stop Buy", "Stop Sell");
                    stopOrderBookDialog.setPriceColumn(Order.STOP);

                    stopOrderBookDialog.addWindowListener(new WindowAdapter() {
                        @Override
                        public void windowClosing(WindowEvent e) {
                            super.windowClosing(e);

                            System.out.printf("Closingn");
                            stopOrderBookDialog.dispose();
                            stopOrderBookDialog.stop();
                            stopOrderBookDialog = null;
                            viewStopOrders.setState(false);
                        }
                    });

                }

                stopOrderBookDialog.setVisible(true);
            } else if (unlimitedOrdersDialog != null) {
                System.out.printf("Set visible = false\n");
                stopOrderBookDialog.setVisible(false);

            }
        });

    }//GEN-LAST:event_viewStopOrdersActionPerformed

    /**
     * @param args the command line arguments
     * @throws java.lang.IllegalAccessException
     * @throws java.lang.InstantiationException
     */
    public static void main(String args[]) throws IllegalAccessException, InstantiationException {

        // Initialize logging
        Logger rootLogger = sesim.Logger.getLogger();

        //   import java.awt.Toolkit;
        // create ConsoleHandler 
        ConsoleHandler consoleHandler = new ConsoleHandler();
        consoleHandler.setLevel(Level.ALL); // alles loggen
        consoleHandler.setFormatter(new SimpleFormatter()); // lesbare Ausgabe

        // Append handler
        rootLogger.addHandler(consoleHandler);
        rootLogger.setLevel(Level.ALL);

        sesim.Logger.debug("Starting application on the new SesimLogger");

        Globals.initGlobals();
        //    Globals.sim.se = new Exchange();
        Globals.sim = new sesim.Sim();

        Globals.prefs_new = Preferences.userRoot().node("/opensesim");
        Globals.prefs_new.put(Globals.PrefKeys.CURRENTFILE, "");

        Globals.setLookAndFeel(Globals.prefs_new.get("laf", "Nimbus"));

        JDialog.setDefaultLookAndFeelDecorated(true);
        JFrame.setDefaultLookAndFeelDecorated(false);
        JPopupMenu.setDefaultLightWeightPopupEnabled(true);

        java.awt.EventQueue.invokeLater(new Runnable() {
            @Override
            public void run() {
                SeSimApplication app = new SeSimApplication();
                app.setLocationRelativeTo(null);
                app.setVisible(true);
            }
        });
    }

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JMenuItem aboutMenuItem;
    private javax.swing.JSpinner accelSpinner;
    private chart.ChartPanel chartPanel;
    private javax.swing.JMenuItem clearMenuItem;
    private gui.Clock clock;
    private gui.Clock clock1;
    private javax.swing.JMenuItem closeMenuItem;
    private javax.swing.JMenuItem deleteMenuItem;
    private javax.swing.JMenuItem editExchangeMenuItem;
    private javax.swing.JMenu editMenu;
    private javax.swing.JMenuItem editPreferences;
    private javax.swing.JMenuItem exitMenuItem;
    private javax.swing.JMenu fileMenu;
    private javax.swing.JMenu helpMenu;
    private javax.swing.JLabel jLabel1;
    private javax.swing.JPanel jPanel2;
    private javax.swing.JScrollPane jScrollPane2;
    private javax.swing.JPopupMenu.Separator jSeparator1;
    private javax.swing.JPopupMenu.Separator jSeparator2;
    private javax.swing.JPopupMenu.Separator jSeparator4;
    private javax.swing.JPopupMenu.Separator jSeparator5;
    private javax.swing.JSplitPane jSplitPane1;
    private javax.swing.JSplitPane jSplitPane2;
    private javax.swing.JSplitPane jSplitPane3;
    private javax.swing.JSplitPane jSplitPane4;
    private javax.swing.JSplitPane jSplitPane5;
    private javax.swing.JTextArea jTextArea1;
    private javax.swing.JToolBar jToolBar1;
    private javax.swing.JMenuBar menuBar;
    private javax.swing.JMenuItem openMenuItem;
    private gui.orderbook.RawOrderBook orderBookNew1;
    private gui.orderbook.OrderBooksHorizontal orderBooksHorizontal;
    private javax.swing.JMenuItem pasteMenuItem;
    private javax.swing.JButton pauseButton;
    private gui.orderbook.QuoteVertical quoteVertical1;
    private javax.swing.JMenuItem resetToDefaultsMenuItem;
    private javax.swing.JButton runButton;
    private javax.swing.JMenuItem saveAsMenuItem;
    private javax.swing.JMenuItem saveMenuItem;
    private javax.swing.JMenu simMenu;
    private javax.swing.JMenuItem simMenuPause;
    private javax.swing.JMenuItem simMenuStart;
    private javax.swing.JMenuItem simMenuStop;
    private gui.Statistics statistics1;
    private javax.swing.JButton stopButton;
    private gui.TraderListPanel traderListPanel1;
    private javax.swing.JMenu viewMenu;
    private javax.swing.JCheckBoxMenuItem viewRawOrderBook;
    private javax.swing.JCheckBoxMenuItem viewStopOrders;
    private javax.swing.JCheckBoxMenuItem viewTraderListCheckBox;
    private javax.swing.JCheckBoxMenuItem viewUnlimitedOrdes;
    // End of variables declaration//GEN-END:variables

}
